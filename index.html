<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ponto Eletrônico - Time Tracking</title>

    <link rel="icon" href="https://www.rw-designer.com/icon-image/21516-256x256x32.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Font Awesome (Ícones) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Lodash para Debounce (Salvamento inteligente) -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            light: '#1e293b',
                            accent: '#3b82f6',
                            success: '#10b981',
                            warning: '#f59e0b',
                            danger: '#ef4444'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .timer-active { animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        [v-cloak] { display: none; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Estilo de Papel para o Dontpad */
        .paper-bg {
            background-color: #fffbeb; /* Amarelo clarinho */
            background-image: linear-gradient(#f7f2d4 1px, transparent 1px);
            background-size: 100% 1.5rem;
            line-height: 1.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen">

    <div id="app" v-cloak class="min-h-screen flex flex-col relative">
        
        <!-- Header -->
        <header class="bg-brand-dark text-white p-4 shadow-lg sticky top-0 z-20">
            <div class="container mx-auto flex justify-between items-center max-w-lg">
                <h1 class="text-xl font-bold flex items-center gap-2 tracking-wide">
                    <i class="fa-solid fa-clock text-brand-accent"></i> Ponto Eletrônico
                </h1>
                <div v-if="currentUser" class="text-sm opacity-80 cursor-pointer hover:opacity-100 transition flex items-center gap-2 px-3 py-1 rounded hover:bg-white/10" @click="logout">
                    <span>Sair</span>
                    <i class="fa-solid fa-sign-out-alt"></i>
                </div>
            </div>
        </header>

        <!-- Conteúdo Principal -->
        <main class="flex-grow container mx-auto p-4 max-w-lg flex flex-col pb-20">
            
            <!-- ========================================== -->
            <!-- TELA 1: SELEÇÃO DE USUÁRIO (HOME)          -->
            <!-- ========================================== -->
            <div v-if="!currentUser" class="flex flex-col gap-6 animate-fade-in py-4">
                <h2 class="text-center text-slate-500 font-medium mb-2">Selecione seu perfil</h2>
                
                <!-- Cards de Usuário (Pedro/Vinicius) -->
                <div v-for="user in ['Pedro', 'Vinicius']" :key="user" @click="selectUser(user)" 
                     class="group bg-white rounded-2xl shadow-sm border border-slate-200 hover:border-blue-500 cursor-pointer transition-all duration-300 relative overflow-hidden">
                    
                    <!-- Badges de Status -->
                    <div v-if="isUserWorking(user) && !isUserPaused(user)" class="absolute top-0 right-0 bg-brand-success text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm flex items-center gap-1">
                        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span> TRABALHANDO
                    </div>
                    <div v-else-if="isUserWorking(user) && isUserPaused(user)" class="absolute top-0 right-0 bg-brand-warning text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl shadow-sm flex items-center gap-1">
                        <i class="fa-solid fa-pause"></i> PAUSADO
                    </div>

                    <div class="p-6 flex items-center gap-4 border-b border-slate-100">
                        <div class="h-14 w-14 rounded-full flex items-center justify-center text-2xl font-bold border relative"
                             :class="user === 'Pedro' ? 'bg-blue-50 text-blue-600 border-blue-100' : 'bg-indigo-50 text-indigo-600 border-indigo-100'">
                            <i :class="user === 'Pedro' ? 'fa-solid fa-user' : 'fa-solid fa-user-astronaut'"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">{{ user === 'Pedro' ? 'Sou o Pedro' : 'Sou o Vinicius' }}</h3>
                            <p class="text-xs text-slate-500">Clique para entrar</p>
                        </div>
                    </div>
                    <!-- Stats Preview -->
                    <div class="grid grid-cols-3 divide-x divide-slate-100 bg-slate-50/50">
                        <div class="p-2 text-center" v-for="(val, label) in getStatsForUser(user)" :key="label">
                            <div class="text-[10px] text-slate-400 uppercase font-bold">{{ label === 'today' ? 'Hoje' : label === 'week' ? 'Semana' : 'Mês' }}</div>
                            <div class="text-xs font-bold text-slate-700">{{ val }}</div>
                        </div>
                    </div>
                </div>

                <!-- DONTPAD GERAL (HOME) -->
                <div class="mt-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-earth-americas"></i> Mural Geral (Público)
                    </h3>
                    <div class="relative">
                        <textarea 
                            v-model="generalNote" 
                            @input="saveGeneralNote"
                            class="w-full h-40 p-4 rounded-xl border border-slate-200 shadow-sm focus:ring-2 focus:ring-brand-accent focus:border-brand-accent outline-none text-sm text-slate-700 resize-none paper-bg"
                            placeholder="Escreva avisos gerais aqui..."></textarea>
                        <div class="absolute bottom-2 right-3 text-[10px] text-slate-400">
                            <span v-if="savingGeneral"><i class="fa-solid fa-sync fa-spin"></i> Salvando...</span>
                            <span v-else>Salvo</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========================================== -->
            <!-- TELA 2: DASHBOARD LOGADO                   -->
            <!-- ========================================== -->
            <div v-else class="space-y-6 animate-fade-in">
                
                <!-- Header Dashboard -->
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-slate-400 mb-1">Olá,</p>
                        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                            {{ currentUser }}
                            <span v-if="isTimerRunning && !isPaused" class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full border border-green-200 animate-pulse">● ON</span>
                            <span v-else-if="isPaused" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full border border-yellow-200"><i class="fa-solid fa-pause"></i> PAUSA</span>
                        </h2>
                    </div>
                    <div class="h-12 w-12 rounded-full bg-brand-light text-white flex items-center justify-center font-bold text-xl shadow-lg ring-2 ring-brand-accent/20 relative">
                        {{ currentUser.charAt(0) }}
                    </div>
                </div>

                <!-- CRONÔMETRO COM PAUSA -->
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-6 text-center relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-slate-100">
                        <div v-if="isTimerRunning && !isPaused" class="h-full bg-brand-success animate-pulse"></div>
                        <div v-if="isPaused" class="h-full bg-brand-warning w-full"></div>
                    </div>
                    
                    <div class="text-slate-400 font-bold mb-2 uppercase tracking-widest text-[10px] mt-2">
                        {{ isPaused ? 'EM PAUSA' : 'DURAÇÃO DA SESSÃO' }}
                    </div>
                    
                    <div class="text-6xl font-mono font-bold mb-8 tracking-tighter transition-colors duration-300"
                         :class="isPaused ? 'text-brand-warning' : (isTimerRunning ? 'text-brand-success' : 'text-slate-800')">
                        {{ formattedTime }}
                    </div>

                    <!-- Botões de Controle -->
                    <div class="grid grid-cols-2 gap-3" v-if="isTimerRunning || isPaused">
                        <!-- Botão Pausar/Continuar -->
                        <button @click="togglePause" 
                            class="py-4 rounded-xl font-bold text-white shadow-lg transition-all transform active:scale-95 flex flex-col items-center justify-center gap-1"
                            :class="isPaused ? 'bg-brand-success hover:bg-green-600 ring-4 ring-green-200' : 'bg-brand-warning hover:bg-yellow-500 ring-4 ring-yellow-100'">
                            <i :class="isPaused ? 'fa-solid fa-play' : 'fa-solid fa-pause'"></i>
                            <span class="text-xs uppercase">{{ isPaused ? 'RETOMAR' : 'PAUSAR' }}</span>
                        </button>

                        <!-- Botão Parar (Stop) -->
                        <button @click="handleStopClick" 
                            class="py-4 rounded-xl font-bold text-white bg-brand-danger hover:bg-red-600 shadow-lg ring-4 ring-red-200 transition-all transform active:scale-95 flex flex-col items-center justify-center gap-1">
                            <i class="fa-solid fa-stop"></i>
                            <span class="text-xs uppercase">FINALIZAR</span>
                        </button>
                    </div>

                    <!-- Botão Iniciar (Só aparece se parado) -->
                    <button v-else
                        @click="handleStartClick"
                        class="w-full py-5 rounded-xl text-white text-xl font-bold bg-brand-success hover:bg-green-600 ring-4 ring-green-200 shadow-xl transition-all transform active:scale-[0.98] flex items-center justify-center gap-3">
                        <i class="fa-solid fa-play"></i>
                        <span>INICIAR TRABALHO</span>
                    </button>
                    
                    <p v-if="isTimerRunning || isPaused" class="mt-4 text-xs text-slate-400">
                        Início: <span class="font-mono text-slate-600">{{ formatHour(startTime) }}</span>
                    </p>
                </div>

                <!-- ABAS DE BLOCO DE NOTAS -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="flex border-b border-slate-100">
                        <button @click="activeTab = 'personal'" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors"
                            :class="activeTab === 'personal' ? 'text-brand-accent bg-blue-50 border-b-2 border-brand-accent' : 'text-slate-400 hover:text-slate-600'">
                            <i class="fa-solid fa-user-pen mr-1"></i> Meu Bloco
                        </button>
                        <button @click="activeTab = 'general'" class="flex-1 py-3 text-xs font-bold uppercase tracking-wider transition-colors"
                            :class="activeTab === 'general' ? 'text-brand-accent bg-blue-50 border-b-2 border-brand-accent' : 'text-slate-400 hover:text-slate-600'">
                            <i class="fa-solid fa-earth-americas mr-1"></i> Mural Geral
                        </button>
                    </div>
                    
                    <div class="relative">
                        <textarea 
                            v-if="activeTab === 'personal'"
                            v-model="personalNote" 
                            @input="savePersonalNote"
                            class="w-full h-48 p-4 border-none outline-none text-sm text-slate-700 resize-none paper-bg"
                            placeholder="Anote suas tarefas, pendências ou rascunhos aqui... (Salvo automaticamente)"></textarea>
                            
                        <textarea 
                            v-else
                            v-model="generalNote" 
                            @input="saveGeneralNote"
                            class="w-full h-48 p-4 border-none outline-none text-sm text-slate-700 resize-none paper-bg"
                            placeholder="Mural de avisos para todos..."></textarea>

                        <div class="absolute bottom-2 right-3 text-[10px] text-slate-400 bg-white/50 px-2 rounded">
                            <span v-if="(activeTab === 'personal' && savingPersonal) || (activeTab === 'general' && savingGeneral)">
                                <i class="fa-solid fa-sync fa-spin"></i> Salvando...
                            </span>
                            <span v-else>Salvo <i class="fa-solid fa-check"></i></span>
                        </div>
                    </div>
                </div>

                <!-- CARDS DE STATS -->
                <div class="grid grid-cols-3 gap-3">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-100 text-center" v-for="(val, label) in currentStats" :key="label">
                        <div class="text-[10px] text-slate-400 uppercase font-bold">{{ label === 'today' ? 'Hoje' : label === 'week' ? 'Semana' : 'Mês' }}</div>
                        <div class="text-sm font-bold text-slate-700">{{ val }}</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- MODAL DE PARADA -->
        <div v-if="showStopModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
                <div class="bg-brand-light p-4 flex items-center gap-3 text-white">
                    <i class="fa-solid fa-pen-to-square text-brand-accent"></i>
                    <h3 class="font-bold">Encerrar Sessão</h3>
                </div>
                
                <div class="p-6">
                    <p class="text-sm text-slate-500 mb-3">O que foi feito?</p>
                    <textarea v-model="workDescription" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm h-24 mb-4"></textarea>
                    
                    <div class="flex gap-3">
                        <button @click="showStopModal = false" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200">Voltar</button>
                        <button @click="confirmStop" class="flex-1 py-3 bg-brand-danger text-white font-bold rounded-xl hover:bg-red-600 shadow-lg">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="toast.show" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl text-white font-medium z-50 transition-all flex items-center gap-2"
             :class="toast.type === 'error' ? 'bg-brand-danger' : 'bg-brand-dark'">
            <i :class="toast.type === 'error' ? 'fa-solid fa-circle-exclamation' : 'fa-solid fa-check-circle text-brand-success'"></i>
            {{ toast.message }}
        </div>
    </div>

    <!-- Lógica da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // =========================================================================
        // CONFIGURAÇÃO FIREBASE
        // =========================================================================
        const firebaseConfig = {
            apiKey: "SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJETO.firebasestorage.app",
            messagingSenderId: "SEU_MESSAGING_ID",
            appId: "SEU_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        signInAnonymously(auth).catch(e => console.error(e));

        const { createApp, ref, computed, onMounted, watch } = Vue;

        createApp({
            setup() {
                // ESTADOS
                const currentUser = ref(localStorage.getItem('ponto_user') || null);
                
                // Timer
                const isTimerRunning = ref(false);
                const isPaused = ref(false);
                const startTime = ref(null);
                const accumulatedPause = ref(0); // Tempo total pausado em segundos
                const pauseStartTime = ref(null); // Timestamp de quando a pausa atual começou
                const elapsedTime = ref(0);
                const timerInterval = ref(null);
                
                // Dados
                const logs = ref([]);
                const userStatuses = ref({});
                
                // UI
                const showStopModal = ref(false);
                const workDescription = ref('');
                const toast = ref({ show: false, message: '', type: 'success' });
                const activeTab = ref('personal');

                // Notas (Dontpad)
                const generalNote = ref('');
                const personalNote = ref('');
                const savingGeneral = ref(false);
                const savingPersonal = ref(false);

                // ==========================
                // COMPUTED
                // ==========================
                const formattedTime = computed(() => {
                    const hours = Math.floor(elapsedTime.value / 3600);
                    const minutes = Math.floor((elapsedTime.value % 3600) / 60);
                    const seconds = elapsedTime.value % 60;
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                });

                const currentStats = computed(() => currentUser.value ? getStatsForUser(currentUser.value) : {});

                // ==========================
                // HELPERS
                // ==========================
                const showToast = (msg, type = 'success') => {
                    toast.value = { show: true, message: msg, type: type };
                    setTimeout(() => toast.value.show = false, 3000);
                };

                const getStatsForUser = (username) => {
                    const userLogs = logs.value.filter(l => l.user === username);
                    const now = new Date();
                    let today = 0, week = 0, month = 0;
                    const startOfDay = new Date(now.setHours(0,0,0,0)).getTime();
                    const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay())).getTime();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
                    
                    userLogs.forEach(l => {
                        if (l.startTime >= startOfDay) today += l.duration;
                        if (l.startTime >= startOfWeek) week += l.duration;
                        if (l.startTime >= startOfMonth) month += l.duration;
                    });
                    
                    const fmt = s => {
                        const h = Math.floor(s/3600), m = Math.floor((s%3600)/60);
                        return h+m===0 ? '0h' : `${h}h ${m}m`;
                    }
                    return { today: fmt(today), week: fmt(week), month: fmt(month) };
                };

                const formatHour = (ts) => ts ? new Date(ts).toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'}) : '--:--';
                
                const isUserWorking = (u) => userStatuses.value[u]?.isWorking;
                const isUserPaused = (u) => userStatuses.value[u]?.isPaused;

                // ==========================
                // TIMER LOGIC
                // ==========================
                const updateRemoteStatus = async () => {
                    if(!currentUser.value) return;
                    await setDoc(doc(db, "status", currentUser.value), {
                        isWorking: isTimerRunning.value,
                        isPaused: isPaused.value,
                        startTime: startTime.value,
                        pauseStartTime: pauseStartTime.value,
                        accumulatedPause: accumulatedPause.value,
                        lastUpdate: serverTimestamp()
                    });
                };

                const calculateElapsed = () => {
                    if (!startTime.value) return 0;
                    const now = Date.now();
                    
                    // Se estiver pausado agora, o tempo não corre além do inicio da pausa
                    if (isPaused.value && pauseStartTime.value) {
                         const timeUntilPause = (pauseStartTime.value - startTime.value) / 1000;
                         return Math.floor(Math.max(0, timeUntilPause - accumulatedPause.value));
                    }
                    
                    // Se estiver rodando
                    return Math.floor((now - startTime.value) / 1000) - accumulatedPause.value;
                };

                const tick = () => elapsedTime.value = calculateElapsed();

                const handleStartClick = () => {
                    startTime.value = Date.now();
                    accumulatedPause.value = 0;
                    isTimerRunning.value = true;
                    isPaused.value = false;
                    
                    // Backup local
                    localStorage.setItem(`ponto_${currentUser.value}`, JSON.stringify({
                        startTime: startTime.value,
                        accumulatedPause: 0,
                        isPaused: false
                    }));
                    
                    updateRemoteStatus();
                    timerInterval.value = setInterval(tick, 1000);
                };

                const togglePause = () => {
                    if (isPaused.value) {
                        // RETOMAR
                        const pausedDurationSeconds = (Date.now() - pauseStartTime.value) / 1000;
                        accumulatedPause.value += pausedDurationSeconds;
                        isPaused.value = false;
                        pauseStartTime.value = null;
                        
                        // Atualizar backup
                        const backup = JSON.parse(localStorage.getItem(`ponto_${currentUser.value}`));
                        backup.isPaused = false;
                        backup.accumulatedPause = accumulatedPause.value;
                        backup.pauseStartTime = null;
                        localStorage.setItem(`ponto_${currentUser.value}`, JSON.stringify(backup));

                    } else {
                        // PAUSAR
                        isPaused.value = true;
                        pauseStartTime.value = Date.now();
                        
                        // Atualizar backup
                        const backup = JSON.parse(localStorage.getItem(`ponto_${currentUser.value}`) || '{}');
                        backup.isPaused = true;
                        backup.pauseStartTime = pauseStartTime.value;
                        localStorage.setItem(`ponto_${currentUser.value}`, JSON.stringify(backup));
                    }
                    updateRemoteStatus();
                    tick(); // Atualiza UI imediatamente
                };

                const handleStopClick = () => {
                    workDescription.value = '';
                    showStopModal.value = true;
                };

                const confirmStop = async () => {
                    showStopModal.value = false;
                    const now = Date.now();
                    
                    // Calcula duração final exata
                    let finalDuration = 0;
                    if (isPaused.value) {
                        // Se parou enquanto estava pausado, o fim é o início da pausa
                        finalDuration = Math.floor(((pauseStartTime.value - startTime.value) / 1000) - accumulatedPause.value);
                    } else {
                        finalDuration = Math.floor(((now - startTime.value) / 1000) - accumulatedPause.value);
                    }

                    if (finalDuration < 5) {
                        showToast("Muito curto (< 5s)", "error");
                    } else {
                        await addDoc(collection(db, "time_logs"), {
                            user: currentUser.value,
                            startTime: startTime.value,
                            endTime: now,
                            duration: finalDuration,
                            description: workDescription.value,
                            createdAt: serverTimestamp()
                        });
                        showToast("Salvo com sucesso!");
                    }

                    // Reset
                    clearInterval(timerInterval.value);
                    isTimerRunning.value = false;
                    isPaused.value = false;
                    accumulatedPause.value = 0;
                    elapsedTime.value = 0;
                    localStorage.removeItem(`ponto_${currentUser.value}`);
                    updateRemoteStatus(); // Limpa status na nuvem
                };

                // ==========================
                // RECOVERY SYSTEM
                // ==========================
                const checkRecovery = () => {
                    const backup = JSON.parse(localStorage.getItem(`ponto_${currentUser.value}`));
                    if (backup && backup.startTime) {
                        startTime.value = backup.startTime;
                        accumulatedPause.value = backup.accumulatedPause || 0;
                        isPaused.value = backup.isPaused || false;
                        pauseStartTime.value = backup.pauseStartTime || null;
                        isTimerRunning.value = true;
                        
                        timerInterval.value = setInterval(tick, 1000);
                        tick();
                    }
                };

                // ==========================
                // NOTAS (DONTPAD)
                // ==========================
                // Usando Lodash debounce para não salvar a cada letra, mas esperar 1s após parar de digitar
                const saveGeneralNote = _.debounce(async () => {
                    if(!generalNote.value) return;
                    savingGeneral.value = true;
                    await setDoc(doc(db, "notes", "general"), { content: generalNote.value }, { merge: true });
                    savingGeneral.value = false;
                }, 1000);

                const savePersonalNote = _.debounce(async () => {
                    if(!currentUser.value || !personalNote.value) return;
                    savingPersonal.value = true;
                    await setDoc(doc(db, "notes", currentUser.value), { content: personalNote.value }, { merge: true });
                    savingPersonal.value = false;
                }, 1000);

                const fetchNotes = () => {
                    // Monitorar Geral
                    onSnapshot(doc(db, "notes", "general"), (doc) => {
                        if(doc.exists() && doc.data().content !== generalNote.value) {
                            // Só atualiza se for diferente para não sobrescrever enquanto digita
                            // (Idealmente teria lógica de cursor, mas para 2 pessoas isso basta)
                            if(!savingGeneral.value) generalNote.value = doc.data().content || '';
                        }
                    });

                    // Monitorar Pessoal (se logado)
                    if(currentUser.value) {
                        onSnapshot(doc(db, "notes", currentUser.value), (doc) => {
                            if(doc.exists() && !savingPersonal.value) {
                                personalNote.value = doc.data().content || '';
                            }
                        });
                    }
                };

                // ==========================
                // LIFECYCLE
                // ==========================
                const selectUser = (u) => {
                    currentUser.value = u;
                    localStorage.setItem('ponto_user', u);
                    checkRecovery();
                    fetchNotes();
                };

                const logout = () => {
                    currentUser.value = null;
                    localStorage.removeItem('ponto_user');
                    isTimerRunning.value = false;
                    clearInterval(timerInterval.value);
                };

                onMounted(() => {
                    // Listener Logs
                    onSnapshot(collection(db, "time_logs"), snap => logs.value = snap.docs.map(d => d.data()));
                    // Listener Status
                    onSnapshot(collection(db, "status"), snap => {
                        const s = {};
                        snap.forEach(d => s[d.id] = d.data());
                        userStatuses.value = s;
                    });
                    
                    fetchNotes(); // Carrega nota geral mesmo deslogado
                    if(currentUser.value) {
                        checkRecovery();
                        fetchNotes(); // Recarrega nota pessoal
                    }
                });

                return {
                    currentUser, selectUser, logout,
                    isTimerRunning, isPaused, formattedTime, startTime,
                    handleStartClick, togglePause, handleStopClick, confirmStop,
                    showStopModal, workDescription, toast,
                    currentStats, getStatsForUser, isUserWorking, isUserPaused, formatHour,
                    // Notas
                    activeTab, generalNote, personalNote, saveGeneralNote, savePersonalNote, savingGeneral, savingPersonal
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
